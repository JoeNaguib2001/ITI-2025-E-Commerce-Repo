<!-- Hello Ahmed -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/bootstrap.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="./css/main-colors.css">

    <link rel="stylesheet" href="./css/loginstyle.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">


    <title>Login</title>
    <style>

    </style>
</head>

<body>

    <div class="outer-container container-fluid">
        <!-- Toast Container -->
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="bootstrapToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notification</strong>
                    <small>Just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage">
                    Message goes here.
                </div>
            </div>
        </div>
        <!-- End Toast Container -->
        <form class="loginform">
            <div class="row">
                <div class="inner-container col-10  col-md-8 col-lg-6 col-xl-3">
                    <!-- Toggler Effect Between Login And Signup -->
                    <div style="display: flex; margin-bottom: 20px; position: relative;" class="mode-toggler">
                        <div id="slider"
                            style="position: absolute; width: 50%; height: 100%;  border-radius: 5px; transition: transform 0.3s ease-in-out;">
                        </div>
                        <span id="loginTab"
                            style="flex: 1; padding: 12px 0; cursor: pointer; text-align: center; position: relative; z-index: 2;">Log
                            in</span>
                        <span id="signupTab"
                            style="flex: 1; padding: 12px 0; cursor: pointer; text-align: center; position: relative; z-index: 2;">Sign
                            up</span>
                    </div>
                    <!-- End Toggler -->
                    <!-- User Icon -->
                    <div class="d-flex justify-content-center">
                        <img id="img-profile" src="./Images/login.png">
                    </div>
                    <!-- Begin Inputs -->
                    <!-- FullName -->
                    <div class="d-flex">
                        <input type="text" id="fullname" name="fullname" placeholder="FullName" required disabled
                            class="forSignUpOnly" style="display: none;" maxlength="20">
                    </div>
                    <!-- Email -->
                    <div class="d-flex">
                        <input type="email" id="email" name="email" placeholder="Email" required disabled
                            class="forSignUpOnly" style="display: none;">
                    </div>
                    <!-- UserName & Password & ConfirmPassword & Forgot & Remember & Submit  -->
                    <div class="d-flex flex-column">
                        <input type="text" id="username" name="username" placeholder="Username" required minlength="6"
                            maxlength="20">
                        <div id="username-validation" style="height: 0px !important;">
                        </div>
                        <div class="position-relative d-flex align-items-center">
                            <input type="password" id="password" name="password" placeholder="Password" required
                                class="password" maxlength="20" onkeyup="checkPasswordStrength()">
                            <i class="fa-solid fa-eye-slash show-hide-pass"></i>
                            <div id="progress-container"
                                class="position-absolute d-flex flex-column align-items-center d-none"
                                style="right: 5px;">
                                <!-- Strength Text -->
                                <small id="strength-text" class="text-white"
                                    style="margin-bottom: 2px; font-size: 12px; display: block;">Very
                                    Weak</small>
                                <!-- Progress Bar Sections -->
                                <div class="d-flex" style="gap: 2px;">
                                    <div class="progress-segment" style="width: 15px; height: 8px; border-radius: 2px;">
                                    </div>
                                    <div class="progress-segment" style="width: 15px; height: 8px; border-radius: 2px;">
                                    </div>
                                    <div class="progress-segment" style="width: 15px; height: 8px; border-radius: 2px;">
                                    </div>
                                    <div class="progress-segment" style="width: 15px; height: 8px; border-radius: 2px;">
                                    </div>
                                </div>
                            </div>
                            <!-- <small id="strength-text" class="position-absolute text-white" style="right: -60px;">Very
                                            Weak</small> -->
                        </div>
                        <div class="d-flex confirmpassowrd-div position-relative">
                            <input type="password" id="confirmpassword" name="password" placeholder="Confirm Password"
                                required class="forSignUpOnly password" style="display: none;" disabled maxlength="20">
                            <i class="fa-solid fa-circle-check text-success position-absolute"
                                id="confirm-password-success-icon"
                                style="top:40%; right:30px; font-size: 18px; display: none;"></i>
                            <i class="fa-solid fa-circle-xmark text-danger position-absolute "
                                id="confirm-password-fail-icon"
                                style="top:40%; right:30px; font-size: 18px; display: none;"></i>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 70%; margin:15px auto">
                            <a href="#" class="forgot">Forgot your
                                password?</a>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 70%; margin:15px auto">
                            <input type="radio" id="remember"> <label for="remember" class="remember">Remember
                                me</label>
                        </div>
                        <!-- End Inputs -->
                        <div>
                            <div class=" d-flex justify-content-center"><input type="submit" class="submit"
                                    value="Log in">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </form>
    </div>

    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/utilities.js"></script>
    <script>
        let confirmPasswordFailIcon = document.getElementById("confirm-password-fail-icon");
        let confirmSuccessIcon = document.getElementById("confirm-password-success-icon");

        //Toggler Animation Sign In / Sign Up Logic + Set Current Mode To Either Sign-In Or Sign-Up
        let submit = document.querySelector('input[type="submit"]');
        const loginTab = document.getElementById("loginTab");
        const signupTab = document.getElementById("signupTab");
        const slider = document.getElementById("slider");
        const container = document.querySelector(".container");

        loginTab.addEventListener("click", () => {
            clearFormInputs();
            slider.style.transform = "translateX(0%)";
            loginTab.style.color = "white";
            signupTab.style.color = "gray";
            submit.value = "Log in";
            currentMode = "login";
            document.querySelectorAll(".forSignUpOnly").forEach(input => {
                input.disabled = true;
                input.style.display = "none";
            });
        });

        signupTab.addEventListener("click", () => {
            clearFormInputs();
            slider.style.transform = "translateX(100%)";
            signupTab.style.color = "white";
            loginTab.style.color = "gray";
            submit.value = "Sign up";
            currentMode = "signup";
            document.querySelectorAll("input:disabled").forEach(input => {
                input.disabled = false;
                input.style.display = "block";
            });
            window.scrollTo(0, document.body.scrollHeight);
        });




        //Check If User Is Already Signed In, Direct To Shop Page
        if (localStorage.getItem("rememberMe") === "true") {
            localStorage.setItem("welcomeMessage", "Welcome back, " + localStorage.getItem("username"));
            window.location.href = "home.html";
        }


        //Show / Hide Password Functionality
        let showHidePass = document.querySelector('.show-hide-pass');
        let showPass = false;
        showHidePass.addEventListener('click', function () {
            if (showPass) {
                showHidePass.classList.add('fa-eye-slash');
                showHidePass.classList.remove('fa-eye');
                showPass = false;
                document.querySelectorAll('.password').forEach(el => {

                    el.setAttribute('type', 'text');
                });
            }
            else {
                showHidePass.classList.add('fa-eye');
                showHidePass.classList.remove('fa-eye-slash');
                showPass = true;
                document.querySelectorAll('.password').forEach(el => {
                    el.setAttribute('type', 'password');
                });
            }
        });



        //Allow Deslecting A Radio Button
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('click', function () {
                if (this.checked && this.dataset.wasChecked) {
                    this.checked = false;
                    this.dataset.wasChecked = "";
                } else {
                    this.dataset.wasChecked = "true";
                }
            });
        });


        //Handle Sign-In / Sign-Up Logic
        let currentMode = "login";
        document.querySelector("form").addEventListener("submit", async function (event) {
            event.preventDefault();

            let username = document.getElementById("username");
            let password = document.getElementById("password");

            if (currentMode === "login") {
                let isValidUser = await checkUser(username.value, password.value);
                if (isValidUser) {
                    localStorage.setItem("isSignedIn", "true");
                    localStorage.setItem("username", username.value);
                    if (document.querySelector("#remember").checked) {
                        localStorage.setItem("rememberMe", "true");
                    } else {
                        localStorage.setItem("rememberMe", "false");
                    }
                    localStorage.setItem("welcomeMessage", "Welcome back, " + username.value);
                    setTimeout(() => {
                        window.location.href = "shop.html";
                    }, 2000);
                } else {
                    ShowBootstrapToast("Invalid Username or Password", "danger");
                }
            }
            else if (currentMode === "signup") {
                let fullName = document.getElementById("fullname").value;
                let userName = document.getElementById("username").value;
                let password = document.getElementById("password").value;
                let email = document.getElementById("email").value;
                let userType = "user";

                let userData = { fullName, userName, password, email, userType };

                try {
                    let response = await fetch("http://localhost:3000/signup", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(userData)
                    });

                    let result = await response.json();

                    if (response.ok) {
                        ShowBootstrapToast(result.message, "success");
                        localStorage.setItem("isSignedIn", "true");
                        localStorage.setItem("username", userName);
                        setTimeout(() => {
                            window.location.href = "shop.html";
                        }, 2000);
                    } else {
                        ShowBootstrapToast(result.message, "danger");
                    }
                } catch (error) {
                    ShowBootstrapToast("❌ حدث خطأ أثناء الاتصال بالسيرفر", "danger");
                }
            }
        });

        //Validate User Input On Sign-In
        async function checkUser(userName, password) {
            try {
                const response = await fetch('./Data/Accounts.Json');

                if (!response.ok) {
                    console.error("Error loading JSON file");
                    return false;
                }

                const accounts = await response.json();
                console.log("Accounts Data:", accounts);

                const user = accounts.find(acc => acc.userName === userName);

                if (!user) {
                    console.warn("User not found!");
                    return false;
                }

                console.log("Stored Password:", user.password);
                console.log("Entered Password:", password);

                if (user.password === password) {
                    return true;
                } else {
                    console.warn("Incorrect password");
                    return false;
                }
            } catch (error) {
                console.error("Error fetching or parsing JSON:", error);
                return false;
            }
        }




        function checkPasswordStrength() {
            document.getElementById("confirmpassword").value = "";
            confirmPasswordFailIcon.style.display = "none";
            confirmSuccessIcon.style.display = "none";

            if (currentMode === "login") return; // Skip if in login mode
            let password = document.getElementById("password").value;
            let progressContainer = document.getElementById("progress-container");
            let strengthText = document.getElementById("strength-text");
            let segments = document.querySelectorAll(".progress-segment");

            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[@$!%*?&]/.test(password)) strength++;

            let strengthLevels = ["Very Weak", "Weak", "Fair", "Good", "Strong"];
            let colors = ["#FF0000", "#FF8C00", "#FFD700", "#32CD32", "#008000"];

            // Show/hide progress container
            progressContainer.classList.toggle("d-none", password.length === 0);

            // Update text & color
            strengthText.textContent = strengthLevels[strength];

            // Reset segments
            segments.forEach((seg, index) => {
                seg.style.backgroundColor = "#ddd";
                if (index < strength) {
                    seg.style.backgroundColor = colors[strength];
                }
            });
        }


        let confirmPassowrdDiv = document.querySelector(".confirmpassowrd-div");
        let pass = document.getElementById("password");
        document.getElementById("confirmpassword").addEventListener("keyup", function () {
            if (pass.value === "") {
                this.value = "";
                pass.focus();
                return;
            }
            if (this.value == "") {
                confirmPasswordFailIcon.style.display = "none";
                confirmSuccessIcon.style.display = "none";
                return;
            }

            let password = document.getElementById("password").value;
            let confirmPassword = this.value;
            if (confirmPassword !== password) {
                confirmPasswordFailIcon.style.display = "block";
                confirmSuccessIcon.style.display = "none";
            } else {
                confirmPasswordFailIcon.style.display = "none";
                confirmSuccessIcon.style.display = "block";
            }
        });

        document.getElementById("username").addEventListener("keypress", function (event) {
            if (event.key === " ") {
                event.preventDefault();
                ShowBootstrapToast("Spaces are not allowed in the username.", "danger");
            }
        });
        document.getElementById("username").addEventListener("keyup", function () {
            if (currentMode === "login") return; // Skip if in login mode
            let usernameValidation = document.getElementById("username-validation");
            let username = this.value;
            if (username.length < 6) {
                usernameValidation.innerText = "Username must be at least 6 characters long.";
                usernameValidation.style.color = "red";

            }
            else if (username.length > 20) {
                usernameValidation.innerText = "Username cannot be more than 20 charachters.";
                usernameValidation.style.color = "red";
            }
            else if (!/^[a-zA-Z0-9]+$/.test(username)) {
                usernameValidation.innerText = "Username can only contain letters and numbers.";
                usernameValidation.style.color = "red";
            } else if (username.length >= 3 && username.length <= 20 && /^[a-zA-Z0-9]+$/.test(username)) {
                fetch('./Data/Accounts.json')
                    .then(response => response.json())
                    .then(accounts => {
                        const userExists = accounts.some(account => account.userName === username);
                        if (userExists) {
                            usernameValidation.innerText = "Username already exists.";
                            usernameValidation.style.color = "red";
                        } else {
                            usernameValidation.innerText = "Valid Username";
                            usernameValidation.style.color = "green";
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching or parsing JSON:", error);
                        usernameValidation.innerText = "Error validating username.";
                        usernameValidation.style.color = "red";
                    });
                usernameValidation.innerText = "Valid Username";
                usernameValidation.style.color = "green";
            }
            else {
                usernameValidation.innerText = "";
            }
        });

        // Function to clear all inputs and uncheck checkboxes
        function clearFormInputs() {
            // Clear all input fields
            document.querySelectorAll("input").forEach(input => {
                if (input.type === "text" || input.type === "email" || input.type === "password") {
                    input.value = "";
                }
            });

            // Uncheck all checkboxes
            document.querySelectorAll("input[type='checkbox']").forEach(checkbox => {
                checkbox.checked = false;
            });
        }

    </script>

</body>

</html>